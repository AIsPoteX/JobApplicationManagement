{% extends 'jobs/base.html' %}

{% block content %}
<div class="toolbar">
    <a href="{% url 'add_job' %}" class="btn">Add</a>
    
    <div class="sort-links">
        Sort by:
        <a href="?sort=created_at" {% if current_sort == 'created_at' %}class="active"{% endif %}>Default</a>
        <a href="?sort=application_deadline" {% if current_sort == 'application_deadline' %}class="active"{% endif %}>ES</a>
        <a href="?sort=first_interview_date" {% if current_sort == 'first_interview_date' %}class="active"{% endif %}>First</a>
    </div>

    <div class="brief-search">
        <input id="brief-company" type="text" placeholder="Input company name" />
        <button id="brief-btn" class="btn btn-small" type="button">Generate</button>
    </div>
</div>

<div id="brief-panel" class="brief-panel" style="display:none;">
    <div class="brief-header">
        <strong id="brief-title"></strong>
        <button id="brief-close" class="btn btn-small" type="button">Close</button>
    </div>
    <div id="brief-status" class="brief-status"></div>
    <div id="brief-body" class="brief-body"></div>
</div>

{% if jobs %}
<table>
    <thead>
        <tr>
            <th>Name</th>
            <th>ES</th>
            <th>TEST</th>
            <th>Interview</th>
            <th class="col-memo">Memo</th>
        </tr>
    </thead>
    <tbody>
        {% for job in jobs %}
        <tr class="job-row">
            <td rowspan="2">
                <div><strong>{{ job.company_name }}</strong></div>
                <div style="margin-top:6px; display:flex; gap:6px; flex-wrap:wrap;">
                    <a href="{% url 'edit_job' job.id %}" class="btn btn-small">Edit</a>
                    <form method="post" action="{% url 'delete_job' job.id %}" style="display: inline;" 
                          onsubmit="return confirm('Delete {{ job.company_name }} ?')">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger btn-small">Del</button>
                    </form>
                </div>
            </td>
            
            <!-- 投递截至日期 -->
            <td>
                <form method="post" action="{% url 'update_date' %}" class="date-form">
                    {% csrf_token %}
                    <input type="hidden" name="job_id" value="{{ job.id }}">
                    <input type="hidden" name="field" value="application_deadline">
                    <input type="date" name="date_value" 
                           value="{% if job.application_deadline %}{{ job.application_deadline|date:'Y-m-d' }}{% endif %}"
                           onchange="this.form.submit()" class="date-input">
                </form>
            </td>
            
            <!-- 网测截至日期 -->
            <td>
                <form method="post" action="{% url 'update_date' %}" class="date-form">
                    {% csrf_token %}
                    <input type="hidden" name="job_id" value="{{ job.id }}">
                    <input type="hidden" name="field" value="online_test_deadline">
                    <input type="date" name="date_value" 
                           value="{% if job.online_test_deadline %}{{ job.online_test_deadline|date:'Y-m-d' }}{% endif %}"
                           onchange="this.form.submit()" class="date-input">
                </form>
            </td>
            
            <!-- 面试日期 -->
            <td>
                <form method="post" action="{% url 'update_date' %}" class="date-form">
                    {% csrf_token %}
                    <input type="hidden" name="job_id" value="{{ job.id }}">
                    <input type="hidden" name="field" value="first_interview_date">
                    <input type="date" name="date_value" 
                           value="{% if job.first_interview_date %}{{ job.first_interview_date|date:'Y-m-d' }}{% endif %}"
                           onchange="this.form.submit()" class="date-input">
                </form>
            </td>
            
            <!-- 备注内容 + 已上传 PDF 链接 -->
            <td class="col-memo">
                <div class="note-text">
                    {% if job.notes %}
                        {{ job.notes }}
                    {% else %}
                        -
                    {% endif %}
                </div>
                {% if job.pdf_file %}
                    <div class="note-file" style="margin-top: 4px;">
                        <a href="{{ job.pdf_file.url }}" target="_blank" title="{{ job.pdf_filename }}">{{ job.pdf_filename }}</a>
                    </div>
                {% endif %}
            </td>
            
        </tr>
        <tr class="status-row">
            <!-- 投递状态 -->
            <td>
                <form method="post" action="{% url 'update_status' %}" class="status-form">
                    {% csrf_token %}
                    <input type="hidden" name="job_id" value="{{ job.id }}">
                    <input type="hidden" name="field" value="application_status">
                    <select name="status" onchange="this.form.submit()" class="status-select">
                        <option value="---" {% if job.application_status == '---' %}selected{% endif %}>---</option>
                        <option value="pass" {% if job.application_status == 'pass' %}selected{% endif %}>Pass</option>
                        <option value="fail" {% if job.application_status == 'fail' %}selected{% endif %}>Fail</option>
                    </select>
                </form>
            </td>
            
            <!-- 网测状态 -->
            <td>
                <form method="post" action="{% url 'update_status' %}" class="status-form">
                    {% csrf_token %}
                    <input type="hidden" name="job_id" value="{{ job.id }}">
                    <input type="hidden" name="field" value="online_test_status">
                    <select name="status" onchange="this.form.submit()" class="status-select">
                        <option value="---" {% if job.online_test_status == '---' %}selected{% endif %}>---</option>
                        <option value="pass" {% if job.online_test_status == 'pass' %}selected{% endif %}>Pass</option>
                        <option value="fail" {% if job.online_test_status == 'fail' %}selected{% endif %}>Fail</option>
                    </select>
                </form>
            </td>
            
            <!-- 面试状态 -->
            <td>
                <div class="status-round-row">
                    <form method="post" action="{% url 'update_status' %}" class="status-form">
                        {% csrf_token %}
                        <input type="hidden" name="job_id" value="{{ job.id }}">
                        <input type="hidden" name="field" value="first_interview_status">
                        <select name="status" onchange="this.form.submit()" class="status-select">
                            <option value="---" {% if job.first_interview_status == '---' %}selected{% endif %}>---</option>
                            <option value="pass" {% if job.first_interview_status == 'pass' %}selected{% endif %}>Pass</option>
                            <option value="fail" {% if job.first_interview_status == 'fail' %}selected{% endif %}>Fail</option>
                        </select>
                    </form>
                    <select class="round-select" aria-label="Interview round">
                        <option value="1st" selected>1st</option>
                        <option value="2nd">2nd</option>
                        <option value="3rd">3rd</option>
                        <option value="4th">4th</option>
                        <option value="5th">5th</option>
                        <option value="6th">6th</option>
                        <option value="7th">7th</option>
                        <option value="8th">8th</option>
                        <option value="9th">9th</option>
                        <option value="10th">10th</option>
                        <option value="Final">Final</option>
                    </select>
                </div>
            </td>
            
            <!-- 备注结果 -->
            <td>
                <form method="post" action="{% url 'update_status' %}" class="status-form">
                    {% csrf_token %}
                    <input type="hidden" name="job_id" value="{{ job.id }}">
                    <input type="hidden" name="field" value="notes_result">
                    <select name="status" onchange="this.form.submit()" class="status-select">
                        <option value="---" {% if job.notes_result == '---' %}selected{% endif %}>---</option>
                        <option value="pass" {% if job.notes_result == 'pass' %}selected{% endif %}>Pass</option>
                        <option value="fail" {% if job.notes_result == 'fail' %}selected{% endif %}>Fail</option>
                    </select>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% else %}
<p style="text-align: center; color: #666; margin-top: 50px;">
<a href="{% url 'add_job' %}">Add first record</a>
</p>
{% endif %}

<script>
(function() {
    const btn = document.getElementById('brief-btn');
    const input = document.getElementById('brief-company');
    const panel = document.getElementById('brief-panel');
    const title = document.getElementById('brief-title');
    const body = document.getElementById('brief-body');
    const statusEl = document.getElementById('brief-status');
    const closeBtn = document.getElementById('brief-close');

    function colorDateInputs() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        document.querySelectorAll('.date-input').forEach(function(el) {
            el.classList.remove('date-warning', 'date-danger');
            const val = el.value;
            if (!val) return;
            const target = new Date(val);
            target.setHours(0, 0, 0, 0);
            const diffDays = (target - today) / (1000 * 60 * 60 * 24);
            if (diffDays < 0) {
                el.classList.add('date-danger');
            } else if (diffDays <= 3) {
                el.classList.add('date-warning');
            }
        });
    }

    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return '';
    }

    function setStatus(text, isError) {
        statusEl.textContent = text;
        statusEl.style.color = isError ? '#c00' : '#333';
    }

    function colorStatusSelects() {
        document.querySelectorAll('.status-select').forEach(function(sel) {
            sel.classList.remove('status-pass', 'status-fail', 'status-default');
            const val = sel.value;
            if (val === 'pass') {
                sel.classList.add('status-pass');
            } else if (val === 'fail') {
                sel.classList.add('status-fail');
            } else {
                sel.classList.add('status-default');
            }
        });
    }

    function colorRoundSelects() {
        document.querySelectorAll('.round-select').forEach(function(sel) {
            sel.classList.remove('round-final');
            if (sel.value === 'Final') {
                sel.classList.add('round-final');
            }
        });
    }

    async function fetchBrief() {
        const name = (input.value || '').trim();
        if (!name) {
            setStatus('请先输入公司名。', true);
            panel.style.display = 'block';
            return;
        }

        setStatus('生成中，请稍候...', false);
        body.textContent = '';
        title.textContent = name;
        panel.style.display = 'block';

        try {
            const resp = await fetch('{% url "company_brief" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': getCookie('csrftoken'),
                },
                body: new URLSearchParams({ company_name: name }),
            });

            const data = await resp.json();
            if (!resp.ok) {
                throw new Error(data.error || '请求失败');
            }

            setStatus('生成完成', false);
            body.textContent = data.brief || '未返回内容';
        } catch (err) {
            setStatus(err.message, true);
            body.textContent = '';
        }
    }

    btn.addEventListener('click', fetchBrief);
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            fetchBrief();
        }
    });
    closeBtn.addEventListener('click', function() {
        panel.style.display = 'none';
    });

    colorDateInputs();
    colorStatusSelects();
    colorRoundSelects();
    document.querySelectorAll('.status-select').forEach(function(sel) {
        sel.addEventListener('change', colorStatusSelects);
    });
    document.querySelectorAll('.round-select').forEach(function(sel) {
        sel.addEventListener('change', colorRoundSelects);
    });
})();
</script>
{% endblock %}
